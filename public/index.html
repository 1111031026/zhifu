<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>懷舊治療系統 (Vue + Python - 純文字版)</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body>

    <div id="app">
        <h1>懷舊對話課程</h1>
        <div class="controls">
            <input type="text" v-model="theme" :disabled="isLoading" placeholder="輸入懷舊主題...">
            <button @click="generateContent" :disabled="isLoading">
                {{ isLoading ? '生成中...' : '開始課程' }}
            </button>
        </div>

        <div id="status-text">{{ statusText }}</div>

        <div v-if="jobResult">
            <div id="media-container">
                <video v-if="isVideoReady" :src="jobResult.video_url" autoplay controls loop key="video"></video>
                <img v-else :src="jobResult.image_url" alt="懷舊圖片" key="image">
            </div>

            <div id="llm-dialogue">
                <p>{{ jobResult.text_content }}</p>
                </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue

        // 您的 Python Flask 伺服器運行的網址
        const API_BASE_URL = "http://localhost:5000";

        createApp({
            data() {
                return {
                    theme: '廟口',
                    isLoading: false,
                    statusText: '請輸入主題並開始課程',
                    jobResult: null,
                    isVideoReady: false,
                    pollingInterval: null
                }
            },
            methods: {
                async generateContent() {
                    this.isLoading = true;
                    this.statusText = '1/3 (Gemini & T2I) 正在生成對話與圖片...'; // <-- UPDATED
                    this.jobResult = null;
                    this.isVideoReady = false;
                    if (this.pollingInterval) clearInterval(this.pollingInterval);

                    try {
                        // [A 方案 流程 1]
                        const response = await fetch(`${API_BASE_URL}/api/generate-content`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ theme: this.theme })
                        });

                        if (!response.ok) {
                            throw new Error('生成初始素材失敗');
                        }

                        const data = await response.json();
                        this.jobResult = data;
                        this.statusText = '2/3 (SVD) 靜態圖完成！正在背景生成動態影片...'; // <-- UPDATED

                        // [A 方案 流程 2]
                        // 開始輪詢 (Polling) 檢查影片狀態
                        this.startPolling(data.job_id);

                    } catch (error) {
                        this.statusText = `錯誤: ${error.message}`;
                        this.isLoading = false;
                    }
                },

                startPolling(jobId) {
                    this.pollingInterval = setInterval(async () => {
                        try {
                            const response = await fetch(`${API_BASE_URL}/api/check-status?id=${jobId}`);
                            const data = await response.json();

                            if (data.status === 'completed') {
                                this.statusText = '3/3 影片已完成！'; // <-- UPDATED
                                clearInterval(this.pollingInterval);
                                
                                this.jobResult.video_url = data.video_url;
                                this.isVideoReady = true;
                                this.isLoading = false; 

                            } else if (data.status === 'failed') {
                                this.statusText = '影片生成失敗。';
                                clearInterval(this.pollingInterval);
                                this.isLoading = false;
                            } else {
                                this.statusText = '2/3 (SVD) 影片生成中，請稍候...'; // <-- UPDATED
                            }
                        } catch (error) {
                            this.statusText = '輪詢檢查失敗';
                            clearInterval(this.pollingInterval);
                            this.isLoading = false;
                        }
                    }, 3000); 
                }
            },
            beforeUnmount() {
                if (this.pollingInterval) clearInterval(this.pollingInterval);
            }
        }).mount('#app')
    </script>
</body>
</html>